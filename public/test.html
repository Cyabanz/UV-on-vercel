<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='utf-8'>
  <title>Enhanced Fusion Tabs</title>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>
  <meta name="theme-color" content="#202124">
  
  <!-- Critical: Load UV scripts first and register service worker immediately -->
  <script src="/uv/uv.bundle.js"></script>
  <script src="/uv/uv.config.js"></script>
  <script>
    // Immediate service worker registration - critical for private browsing
    if ("serviceWorker" in navigator) {
      // Check if we're in private browsing mode
      const isPrivateBrowsing = () => {
        return new Promise((resolve) => {
          // Try to use indexedDB - it's restricted in private browsing
          try {
            const request = window.indexedDB.open('test');
            request.onerror = () => resolve(true);
            request.onsuccess = () => {
              window.indexedDB.deleteDatabase('test');
              resolve(false);
            };
          } catch {
            resolve(true);
          }
        });
      };

      // Register service worker immediately
      window.addEventListener("load", async () => {
        try {
          const isPrivate = await isPrivateBrowsing();
          console.log('Private browsing detected:', isPrivate);
          
          const registration = await navigator.serviceWorker.register("/uv/sw.js", {
            scope: __uv$config.prefix,
          });
          console.log('Service worker registered successfully:', registration);
        } catch (error) {
          console.error('Service worker registration failed:', error);
          // Show fallback UI or warning
          document.body.insertAdjacentHTML('afterbegin', 
            '<div style="background: #f44336; color: white; padding: 10px; text-align: center;">' +
            'Private browsing mode detected. Some features may not work properly. ' +
            'Please use regular browsing mode for full functionality.' +
            '</div>'
          );
        }
      });
    }
  </script>
  
  <!-- Load other scripts after UV registration -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js" defer></script>
  
  <style>
    :root {
      --bg: #202124;
      --fg: #e8eaed;
      --section-bg: #23242b;
      --border: #5f6368;
      --hover: #3c4043;
      --accent: #8ab4f8;
      --danger: #f28b82;
      --success: #81c995;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--fg);
      height: 100vh;
      overflow: hidden;
    }

    .browser-container {
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Tab bar styles */
    .tab-bar {
      background: var(--section-bg);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      min-height: 40px;
      padding: 0 8px;
    }

    .tabs-container {
      display: flex;
      flex: 1;
      overflow-x: auto;
      scrollbar-width: none;
    }

    .tabs-container::-webkit-scrollbar {
      display: none;
    }

    .tab {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      background: var(--hover);
      border: 1px solid var(--border);
      border-radius: 8px 8px 0 0;
      margin-right: 2px;
      min-width: 120px;
      max-width: 240px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tab:hover {
      background: var(--section-bg);
    }

    .tab.active {
      background: var(--bg);
      border-bottom-color: var(--bg);
    }

    .tab-favicon {
      width: 16px;
      height: 16px;
      margin-right: 8px;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23e8eaed"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>') center/contain;
    }

    .tab-title {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-size: 13px;
    }

    .tab-close {
      width: 16px;
      height: 16px;
      border: none;
      background: none;
      cursor: pointer;
      margin-left: 8px;
      opacity: 0.7;
      transition: opacity 0.2s ease;
    }

    .tab-close:hover {
      opacity: 1;
    }

    .tab-close::before {
      content: 'Ã—';
      color: var(--fg);
      font-size: 16px;
      font-weight: bold;
    }

    .new-tab-btn {
      padding: 8px 12px;
      background: none;
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--fg);
      cursor: pointer;
      margin-left: 8px;
      transition: all 0.2s ease;
    }

    .new-tab-btn:hover {
      background: var(--hover);
    }

    .new-tab-btn::before {
      content: '+';
      font-size: 16px;
      font-weight: bold;
    }

    /* Navigation bar */
    .nav-bar {
      background: var(--section-bg);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 8px 12px;
      gap: 8px;
    }

    .nav-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: none;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease;
    }

    .nav-btn:hover {
      background: var(--hover);
    }

    .nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .url-bar {
      flex: 1;
      padding: 8px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 20px;
      color: var(--fg);
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s ease;
    }

    .url-bar:focus {
      border-color: var(--accent);
    }

    /* Content area */
    .content-area {
      flex: 1;
      position: relative;
      background: var(--bg);
    }

    .tab-content {
      width: 100%;
      height: 100%;
      border: none;
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Status messages */
    .status-message {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 10px 16px;
      border-radius: 6px;
      color: white;
      font-size: 14px;
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }

    .status-message.error {
      background: var(--danger);
    }

    .status-message.success {
      background: var(--success);
    }

    @keyframes slideIn {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }

    /* Theme variations */
    .light-theme {
      --bg: #ffffff;
      --fg: #202124;
      --section-bg: #f8f9fa;
      --border: #dadce0;
      --hover: #f1f3f4;
    }

    .purple-theme {
      --bg: #2a183b;
      --fg: #f9d7ff;
      --section-bg: #391a53;
      --border: #6b46c1;
      --hover: #4c1d95;
    }
  </style>
</head>
<body>
  <div class="browser-container">
    <!-- Tab Bar -->
    <div class="tab-bar">
      <div class="tabs-container" id="tabsContainer">
        <!-- Tabs will be dynamically added here -->
      </div>
      <button class="new-tab-btn" onclick="createNewTab()" title="New Tab"></button>
    </div>

    <!-- Navigation Bar -->
    <div class="nav-bar">
      <button class="nav-btn" id="backBtn" onclick="goBack()" title="Back">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
        </svg>
      </button>
      <button class="nav-btn" id="forwardBtn" onclick="goForward()" title="Forward">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M4 13h12.17l-5.59 5.59L12 20l8-8-8-8-1.41 1.41L16.17 11H4v2z"/>
        </svg>
      </button>
      <button class="nav-btn" onclick="reloadPage()" title="Reload">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.7L15 8h4V4l-1.35 1.35z"/>
        </svg>
      </button>
      <input type="text" class="url-bar" id="urlBar" placeholder="Search or enter URL">
      <button class="nav-btn" onclick="toggleTheme()" title="Toggle Theme">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
        </svg>
      </button>
    </div>

    <!-- Content Area -->
    <div class="content-area" id="contentArea">
      <!-- Tab content iframes will be added here -->
    </div>
  </div>

  <script>
    // Browser state
    let tabs = [];
    let activeTabId = null;
    let tabCounter = 0;

    // Initialize browser
    document.addEventListener('DOMContentLoaded', () => {
      createNewTab('ht://newtab');
      setupEventListeners();
    });

    function setupEventListeners() {
      // URL bar enter key
      document.getElementById('urlBar').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          navigateToUrl(e.target.value);
        }
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.ctrlKey || e.metaKey) {
          switch(e.key) {
            case 't':
              e.preventDefault();
              createNewTab();
              break;
            case 'w':
              e.preventDefault();
              closeTab(activeTabId);
              break;
            case 'r':
              e.preventDefault();
              reloadPage();
              break;
          }
        }
      });
    }

    function createNewTab(url = 'about:blank', title = 'New Tab') {
      const tabId = `tab-${tabCounter++}`;
      const tab = {
        id: tabId,
        url: url,
        title: title,
        element: null,
        iframe: null
      };

      // Create tab element
      const tabElement = document.createElement('div');
      tabElement.className = 'tab';
      tabElement.setAttribute('data-tab-id', tabId);
      tabElement.innerHTML = `
        <div class="tab-favicon"></div>
        <div class="tab-title">${title}</div>
        <button class="tab-close" onclick="closeTab('${tabId}', event)"></button>
      `;
      
      tabElement.addEventListener('click', (e) => {
        if (!e.target.classList.contains('tab-close')) {
          switchToTab(tabId);
        }
      });

      // Create iframe
      const iframe = document.createElement('iframe');
      iframe.className = 'tab-content';
      iframe.setAttribute('data-tab-id', tabId);
      iframe.src = getProxiedUrl(url);

      // Add to DOM
      document.getElementById('tabsContainer').appendChild(tabElement);
      document.getElementById('contentArea').appendChild(iframe);

      // Store references
      tab.element = tabElement;
      tab.iframe = iframe;
      tabs.push(tab);

      // Switch to new tab
      switchToTab(tabId);

      return tabId;
    }

    function switchToTab(tabId) {
      // Remove active state from all tabs
      tabs.forEach(tab => {
        tab.element.classList.remove('active');
        tab.iframe.classList.remove('active');
      });

      // Add active state to selected tab
      const tab = tabs.find(t => t.id === tabId);
      if (tab) {
        tab.element.classList.add('active');
        tab.iframe.classList.add('active');
        activeTabId = tabId;

        // Update URL bar
        updateUrlBar(tab.url);
      }
    }

    function closeTab(tabId, event) {
      if (event) {
        event.stopPropagation();
      }

      const tabIndex = tabs.findIndex(t => t.id === tabId);
      if (tabIndex === -1) return;

      const tab = tabs[tabIndex];
      
      // Remove from DOM
      tab.element.remove();
      tab.iframe.remove();
      
      // Remove from array
      tabs.splice(tabIndex, 1);

      // If this was the active tab, switch to another
      if (activeTabId === tabId) {
        if (tabs.length > 0) {
          const newActiveIndex = Math.min(tabIndex, tabs.length - 1);
          switchToTab(tabs[newActiveIndex].id);
        } else {
          createNewTab();
        }
      }
    }

    function navigateToUrl(input) {
      if (!activeTabId) return;

      const tab = tabs.find(t => t.id === activeTabId);
      if (!tab) return;

      let url = input.trim();
      
      // Determine if it's a URL or search query
      if (!url.includes('://')) {
        if (url.includes('.') && !url.includes(' ')) {
          url = 'https://' + url;
        } else {
          url = `https://www.google.com/search?q=${encodeURIComponent(url)}`;
        }
      }

      // Update tab
      tab.url = url;
      tab.iframe.src = getProxiedUrl(url);
      
      // Update URL bar
      updateUrlBar(url);
    }

    function getProxiedUrl(url) {
      if (!url || url === 'ht://newtab' || url === 'about:blank') {
        return 'data:text/html,<html><body style="margin:0;padding:40px;font-family:system-ui;background:#202124;color:#e8eaed;text-align:center;"><h1>New Tab</h1><p>Enter a URL in the address bar to get started.</p></body></html>';
      }

      // Check if UV is available and working
      if (window.__uv$config && typeof __uv$config.encodeUrl === 'function') {
        try {
          return __uv$config.prefix + __uv$config.encodeUrl(url);
        } catch (error) {
          console.error('UV encoding failed:', error);
          showStatusMessage('Proxy unavailable. Direct connection attempted.', 'error');
          return url;
        }
      }

      return url;
    }

    function updateUrlBar(url) {
      const urlBar = document.getElementById('urlBar');
      if (url && url !== 'about:blank' && url !== 'ht://newtab') {
        // Try to decode if it's a proxied URL
        if (window.__uv$config && url.startsWith(__uv$config.prefix)) {
          try {
            urlBar.value = __uv$config.decodeUrl(url.slice(__uv$config.prefix.length));
          } catch {
            urlBar.value = url;
          }
        } else {
          urlBar.value = url;
        }
      } else {
        urlBar.value = '';
      }
    }

    function goBack() {
      const tab = tabs.find(t => t.id === activeTabId);
      if (tab && tab.iframe.contentWindow) {
        tab.iframe.contentWindow.history.back();
      }
    }

    function goForward() {
      const tab = tabs.find(t => t.id === activeTabId);
      if (tab && tab.iframe.contentWindow) {
        tab.iframe.contentWindow.history.forward();
      }
    }

    function reloadPage() {
      const tab = tabs.find(t => t.id === activeTabId);
      if (tab) {
        tab.iframe.src = tab.iframe.src;
      }
    }

    function toggleTheme() {
      const themes = ['', 'light-theme', 'purple-theme'];
      const currentTheme = document.body.className;
      const currentIndex = themes.indexOf(currentTheme);
      const nextIndex = (currentIndex + 1) % themes.length;
      
      document.body.className = themes[nextIndex];
      document.documentElement.className = themes[nextIndex];
      
      showStatusMessage(`Theme changed to ${themes[nextIndex] || 'dark'}`, 'success');
    }

    function showStatusMessage(message, type = 'success') {
      const statusDiv = document.createElement('div');
      statusDiv.className = `status-message ${type}`;
      statusDiv.textContent = message;
      document.body.appendChild(statusDiv);

      setTimeout(() => {
        statusDiv.remove();
      }, 3000);
    }

    // Make functions globally available
    window.createNewTab = createNewTab;
    window.closeTab = closeTab;
    window.goBack = goBack;
    window.goForward = goForward;
    window.reloadPage = reloadPage;
    window.toggleTheme = toggleTheme;
  </script>
</body>
</html>
